name: Build and Deploy

on:
  push:
    branches:
      - "main"
      - "qa"
      - "prod"
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - qa
          - prod
  workflow_run:
    workflows: ["On Publish Tag"]
    types:
      - completed

permissions:
  contents: read

jobs:
  build-and-deploy-env:
    name: Build and Deploy
    strategy:
      matrix:
        include:
          - environment: dev
            branch: main
            condition: ${{ github.event_name != 'push' || github.ref == 'refs/heads/main' }}
          - environment: qa
            branch: qa
            condition: ${{ github.event_name != 'push' || github.ref == 'refs/heads/qa' || github.event_name == 'workflow_run' }}
          - environment: prod
            branch: prod
            condition: ${{ github.event_name != 'push' || github.ref == 'refs/heads/prod' || github.event_name == 'workflow_run' }}
    runs-on: macos-15
    environment: ${{ matrix.environment }}
    
    steps:
      - name: Check Condition
        if: ${{ matrix.condition }}
        run: echo "Condition met, proceeding with the job."
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ matrix.branch }}

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"

      - name: Install Fastlane
        run: echo "Installing Fastlane Dummy"
        # In a real scenario, you would run the actual fastlane installation command
        # gem install fastlane

      - name: Set BUILD_NUMBER
        if: matrix.environment == 'dev'
        run: |
          git fetch origin main
          BUILD_NUMBER=$(git rev-list --count origin/main)
          echo "BUILD_NUMBER=${BUILD_NUMBER}" >> "$GITHUB_ENV"
          echo "Setting BUILD_NUMBER to ${BUILD_NUMBER} for dev environment"

      - name: Set BUILD_DESCRIPTION
        run: |
          {
            echo "BUILD_DESCRIPTION<<EOF"
            git log -1 --pretty=%B
            echo "EOF"
          } >> "$GITHUB_ENV"
          echo "Set BUILD_DESCRIPTION from last commit message"

      - name: Run Fastlane
        env:
          TURBO_URL: ${{ vars.TURBO_URL }}
        run: |
          echo "Running fastlane ios build_and_deploy_${{ matrix.environment }}"
          # This is a simulation - in a real scenario you would run the actual fastlane command
          echo "TURBO_URL: $TURBO_URL"
          echo "ENVIRONMENT: ${{ matrix.environment }}"
          echo "BRANCH: ${{ matrix.branch }}"
          echo "BUILD_DESCRIPTION: $BUILD_DESCRIPTION"
          if [ "${{ matrix.environment }}" = "dev" ]; then
            echo "BUILD_NUMBER: $BUILD_NUMBER"
          fi