name: Build and Deploy

on:
  push:
    branches:
      - "main"
      - "qa"
      - "prod"
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - qa
          - prod
  workflow_run:
    workflows: ["On Publish Tag"]
    types:
      - completed

permissions:
  contents: read

jobs:
  determine-environment:
    runs-on: ubuntu-latest
    outputs:
      environments: ${{ steps.set-matrix.outputs.environments }}
    steps:
      - id: set-matrix
        run: |
          # Default to empty array
          ENVIRONMENTS="[]"
          
          # For workflow_dispatch, only include the selected environment
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENVIRONMENTS="[\"${{ github.event.inputs.environment }}\"]"
          
          # For push events, only include the branch that was pushed to
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
              ENVIRONMENTS="[\"dev\"]"
            elif [[ "${{ github.ref }}" == "refs/heads/qa" ]]; then
              ENVIRONMENTS="[\"qa\"]"
            elif [[ "${{ github.ref }}" == "refs/heads/prod" ]]; then
              ENVIRONMENTS="[\"prod\"]"
            fi
          
          # For workflow_run from tag workflow, include all environments
          elif [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            ENVIRONMENTS="[\"dev\", \"qa\", \"prod\"]"
          fi
          
          echo "environments=$ENVIRONMENTS" >> $GITHUB_OUTPUT
          echo "Will build for environments: $ENVIRONMENTS"

  build-and-deploy:
    needs: determine-environment
    name: Build and Deploy ${{ matrix.environment }}
    strategy:
      matrix:
        environment: ${{ fromJson(needs.determine-environment.outputs.environments) }}
    runs-on: macos-15
    environment: ${{ matrix.environment }}
    
    steps:
      - name: Set branch name
        id: set-branch
        run: |
          if [[ "${{ matrix.environment }}" == "dev" ]]; then
            echo "BRANCH=main" >> $GITHUB_ENV
          else
            echo "BRANCH=${{ matrix.environment }}" >> $GITHUB_ENV
          fi
          echo "Building for environment ${{ matrix.environment }} using branch $BRANCH"
      
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ env.BRANCH }}

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"

      - name: Install Fastlane
        run: echo "Installing Fastlane Dummy"
        # In a real scenario, you would run the actual fastlane installation command
        # gem install fastlane

      - name: Set BUILD_NUMBER
        if: matrix.environment == 'dev'
        run: |
          git fetch origin main
          BUILD_NUMBER=$(git rev-list --count origin/main)
          echo "BUILD_NUMBER=${BUILD_NUMBER}" >> "$GITHUB_ENV"
          echo "Setting BUILD_NUMBER to ${BUILD_NUMBER} for dev environment"

      - name: Set BUILD_DESCRIPTION
        run: |
          {
            echo "BUILD_DESCRIPTION<<EOF"
            git log -1 --pretty=%B
            echo "EOF"
          } >> "$GITHUB_ENV"
          echo "Set BUILD_DESCRIPTION from last commit message"

      - name: Run Fastlane
        env:
          TURBO_URL: ${{ vars.TURBO_URL }}
        run: |
          echo "Running fastlane ios build_and_deploy_${{ matrix.environment }}"
          # This is a simulation - in a real scenario you would run the actual fastlane command
          echo "TURBO_URL: $TURBO_URL"
          echo "ENVIRONMENT: ${{ matrix.environment }}"
          echo "BRANCH: ${{ env.BRANCH }}"
          echo "BUILD_DESCRIPTION: $BUILD_DESCRIPTION"
          if [ "${{ matrix.environment }}" = "dev" ]; then
            echo "BUILD_NUMBER: $BUILD_NUMBER"
          fi